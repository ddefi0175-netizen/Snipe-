name: Health Check - Production Monitoring

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  health-check:
    runs-on: ubuntu-latest
    env:
      BACKEND_URL: ${{ secrets.BACKEND_URL }}
      FRONTEND_URL: ${{ secrets.FRONTEND_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run health checks
        run: |
          echo "üîç Running automated health checks..."
          
          # Validate that secrets are configured
          if [ -z "$BACKEND_URL" ] || [ -z "$FRONTEND_URL" ]; then
            echo ""
            echo "‚ö†Ô∏è WARNING: Health check secrets are not configured"
            echo ""
            echo "‚ÑπÔ∏è To enable production monitoring, please configure the following secrets in your repository:"
            echo "   - BACKEND_URL: The URL of your backend server (e.g., https://api.example.com)"
            echo "   - FRONTEND_URL: The URL of your frontend application (e.g., https://example.com)"
            echo ""
            echo "üìñ To add secrets:"
            echo "   1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Add BACKEND_URL and FRONTEND_URL with your deployment URLs"
            echo ""
            echo "üìö For detailed setup instructions, see: SECRETS.md in the repository"
            echo ""
            echo "‚úÖ Skipping health checks (secrets not configured)"
            exit 0
          fi
          
          echo "Backend URL: $BACKEND_URL"
          echo "Frontend URL: $FRONTEND_URL"

          # Track overall status
          CHECKS_PASSED=true

          # Test backend health
          echo ""
          echo "=== BACKEND HEALTH CHECK ==="
          BACKEND_HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
          if [ "$BACKEND_HEALTH" = "200" ]; then
            echo "‚úÖ Backend health check passed (HTTP $BACKEND_HEALTH)"
          else
            echo "‚ùå Backend health check failed (HTTP $BACKEND_HEALTH)"
            CHECKS_PASSED=false
          fi

          # Test backend API endpoints
          echo ""
          echo "=== API ENDPOINTS CHECK ==="
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/users" -H "Content-Type: application/json" || echo "000")
          if [ "$API_STATUS" = "200" ] || [ "$API_STATUS" = "401" ] || [ "$API_STATUS" = "403" ]; then
            echo "‚úÖ API endpoints responding (HTTP $API_STATUS)"
          else
            echo "‚ö†Ô∏è API endpoints may have issues (HTTP $API_STATUS)"
          fi

          # Test frontend availability
          echo ""
          echo "=== FRONTEND AVAILABILITY CHECK ==="
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "‚úÖ Frontend is accessible (HTTP $FRONTEND_STATUS)"
          else
            echo "‚ùå Frontend is not accessible (HTTP $FRONTEND_STATUS)"
            CHECKS_PASSED=false
          fi

          echo ""
          if [ "$CHECKS_PASSED" = true ]; then
            echo "‚úÖ All health checks passed!"
          else
            echo "‚ùå Some health checks failed!"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Health check failed!"
          echo "Please review the logs and check your deployment."
          echo "Backend: ${BACKEND_URL}"
          echo "Frontend: ${FRONTEND_URL}"
