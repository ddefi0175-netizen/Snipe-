name: Deploy to Cloudflare

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Note: account_id is configured in wrangler.toml and should not be passed
# as accountId parameter to avoid conflicts. The wrangler-action will read
# it from wrangler.toml automatically.

# Restrict permissions to minimum required
permissions:
  contents: read

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Check CLOUDFLARE_API_TOKEN
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå ERROR: CLOUDFLARE_API_TOKEN secret is not configured"
            echo ""
            echo "Please add this secret:"
            echo "1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: CLOUDFLARE_API_TOKEN"
            echo "4. Value: Your Cloudflare API token"
            echo ""
            exit 1
          fi
          echo "‚úÖ CLOUDFLARE_API_TOKEN is configured"
      
      - name: Check Firebase Secrets
        run: |
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.VITE_FIREBASE_API_KEY }}" ]; then
            MISSING_SECRETS="- VITE_FIREBASE_API_KEY"
          fi
          
          if [ -z "${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}" ]; then
            if [ -n "$MISSING_SECRETS" ]; then
              MISSING_SECRETS="${MISSING_SECRETS}\n- VITE_FIREBASE_AUTH_DOMAIN"
            else
              MISSING_SECRETS="- VITE_FIREBASE_AUTH_DOMAIN"
            fi
          fi
          
          if [ -z "${{ secrets.VITE_FIREBASE_PROJECT_ID }}" ]; then
            if [ -n "$MISSING_SECRETS" ]; then
              MISSING_SECRETS="${MISSING_SECRETS}\n- VITE_FIREBASE_PROJECT_ID"
            else
              MISSING_SECRETS="- VITE_FIREBASE_PROJECT_ID"
            fi
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå ERROR: Missing Firebase secrets:"
            echo -e "$MISSING_SECRETS"
            echo ""
            echo "See SECRETS.md for setup instructions"
            exit 1
          fi
          echo "‚úÖ All required Firebase secrets are configured"

  test:
    needs: validate-secrets
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd Onchainweb
          npm install
      
      - name: Run linter
        run: |
          cd Onchainweb
          npm run lint || echo "No linter configured"
        continue-on-error: true
      
      - name: Run tests
        run: |
          cd Onchainweb
          npm run test || echo "No tests configured"
        continue-on-error: true

  build:
    name: Build Production
    runs-on: ubuntu-latest
    needs: [validate-secrets, test]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd Onchainweb
          npm install
      
      - name: Build production bundle
        run: |
          cd Onchainweb
          npm run build:production
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
          VITE_WALLETCONNECT_PROJECT_ID: ${{ secrets.VITE_WALLETCONNECT_PROJECT_ID }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: Onchainweb/dist
          retention-days: 1

  deploy-workers:
    name: Deploy Workers
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Cloudflare API Token
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå ERROR: CLOUDFLARE_API_TOKEN secret is not configured"
            echo ""
            echo "üìñ To configure this secret:"
            echo "   1. Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: CLOUDFLARE_API_TOKEN"
            echo "   4. Value: Your Cloudflare API token"
            echo ""
            echo "‚ÑπÔ∏è  For detailed setup instructions, see: SECRETS.md"
            exit 1
          fi
          echo "‚úÖ Cloudflare API token is configured"
      
      - name: Validate wrangler.toml
        run: |
          echo "üîç Validating wrangler.toml configuration..."
          
          # Check if wrangler.toml exists
          if [ ! -f "wrangler.toml" ]; then
            echo "‚ùå ERROR: wrangler.toml not found"
            exit 1
          fi
          
          # Check for placeholder values that would cause deployment failure
          if grep -q "_PLACEHOLDER" wrangler.toml; then
            echo "‚ùå ERROR: Found placeholder values in wrangler.toml"
            echo ""
            echo "Placeholder values found:"
            grep -n "_PLACEHOLDER" wrangler.toml || true
            echo ""
            echo "Please replace all placeholder values with actual IDs"
            echo "See wrangler.toml comments for setup instructions"
            exit 1
          fi
          
          echo "‚úÖ wrangler.toml validation passed"
      
      - name: Deploy Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy
        env:
          # Enable verbose output for better error diagnostics
          WRANGLER_LOG: info
      
      - name: Verify worker deployment
        run: |
          echo "‚è≥ Waiting for worker deployment to propagate..."
          sleep 5
          
          # Retry health check up to 3 times
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Checking worker health..."
            
            if curl -f -s -o /dev/null -w "%{http_code}\n" https://snipe-onchainweb.workers.dev/health | grep -q "200"; then
              echo "‚úÖ Worker health check passed"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "‚è≥ Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Worker health check failed after $MAX_RETRIES attempts"
          echo "This may be normal if the worker doesn't have a /health endpoint yet"
          echo "Worker is deployed at: https://snipe-onchainweb.workers.dev"

  deploy-pages:
    name: Deploy Pages
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: Onchainweb/dist
      
      - name: Validate Cloudflare API Token
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå ERROR: CLOUDFLARE_API_TOKEN secret is not configured"
            echo ""
            echo "üìñ To configure this secret:"
            echo "   1. Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   2. Click 'New repository secret'"
            echo "   3. Name: CLOUDFLARE_API_TOKEN"
            echo "   4. Value: Your Cloudflare API token"
            echo ""
            echo "‚ÑπÔ∏è  For detailed setup instructions, see: SECRETS.md"
            exit 1
          fi
          echo "‚úÖ Cloudflare API token is configured"
      
      - name: Verify build artifacts
        run: |
          if [ ! -d "Onchainweb/dist" ]; then
            echo "‚ùå ERROR: Build artifacts not found at Onchainweb/dist"
            exit 1
          fi
          echo "‚úÖ Build artifacts verified"
          echo "üì¶ Contents:"
          ls -la Onchainweb/dist
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: pages deploy Onchainweb/dist --project-name=onchainweb
      
      - name: Verify pages deployment
        run: |
          echo "‚è≥ Waiting for pages deployment to propagate..."
          sleep 10
          
          # Try to verify deployment (may not be immediate)
          echo "üåê Cloudflare Pages should be available at:"
          echo "   https://onchainweb.pages.dev"

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-workers, deploy-pages]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Deployment Status
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "            DEPLOYMENT SUMMARY"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          WORKERS_STATUS="${{ needs.deploy-workers.result }}"
          PAGES_STATUS="${{ needs.deploy-pages.result }}"
          
          echo "Workers Deployment: $WORKERS_STATUS"
          echo "Pages Deployment:   $PAGES_STATUS"
          echo ""
          
          if [ "$WORKERS_STATUS" == "success" ] && [ "$PAGES_STATUS" == "success" ]; then
            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
            echo ""
            echo "üåê Your application is live at:"
            echo "   Frontend: https://onchainweb.pages.dev"
            echo "   Workers:  https://snipe-onchainweb.workers.dev"
            echo ""
          else
            echo "‚ùå DEPLOYMENT FAILED"
            echo ""
            echo "üìã Troubleshooting:"
            
            if [ "$WORKERS_STATUS" != "success" ]; then
              echo "   ‚Ä¢ Check Workers deployment logs above"
              echo "   ‚Ä¢ Verify wrangler.toml has no placeholder values"
              echo "   ‚Ä¢ Ensure KV namespace and R2 bucket exist"
              echo "   ‚Ä¢ Verify CLOUDFLARE_API_TOKEN has correct permissions"
            fi
            
            if [ "$PAGES_STATUS" != "success" ]; then
              echo "   ‚Ä¢ Check Pages deployment logs above"
              echo "   ‚Ä¢ Verify build artifacts were created"
              echo "   ‚Ä¢ Ensure Cloudflare Pages project exists"
            fi
            
            echo ""
            echo "üìñ For detailed setup instructions, see:"
            echo "   ‚Ä¢ SECRETS.md for secret configuration"
            echo "   ‚Ä¢ wrangler.toml comments for resource setup"
            echo ""
            exit 1
          fi
